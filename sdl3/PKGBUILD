# Maintainer: cevdetta
# Contributor: cevdetta

_pkgname=sdl3
pkgname=${_pkgname}-waypure
pkgver=3.4.0
pkgrel=1
pkgdesc="A library for portable low-level access to a video framebuffer, audio output, mouse, and keyboard (Version 3)"
arch=('x86_64')
url="https://github.com/libsdl-org/SDL"
license=('Zlib')
depends=('glibc' 'libglvnd' 'libusb' 'libpipewire' 'libxkbcommon' 'wayland')
makedepends=('cmake' 'mesa' 'ninja' 'vulkan-headers' 'wayland-protocols' 'pipewire')
optdepends=(
  'pipewire: PipeWire audio driver'
  'vulkan-driver: vulkan renderer'
)
provides=("${_pkgname}")
conflicts=("${_pkgname}")
replaces=("${_pkgname}")
source=("${url}/releases/download/release-${pkgver}/SDL3-${pkgver}.tar.gz")
sha256sums=('082cbf5f429e0d80820f68dc2b507a94d4cc1b4e70817b119bbb8ec6a69584b8')

build() {
  local _cmake_options=(
    -B build -G Ninja
    -D CMAKE_BUILD_TYPE=None
    -D CMAKE_INSTALL_PREFIX=/usr

    -DSDL_ASSERTIONS=disabled
    -DSDL_SHARED=ON
    -DSDL_STATIC=OFF
    -DSDL_DEPS_SHARED=OFF # link rather than dlopen() where possible
    -DSDL_RPATH=OFF       # Use an rpath when linking SDL" ${SDL_RPATH_DEFAULT})

    -DSDL_AUDIO=ON
    -DSDL_VIDEO=ON
    -DSDL_RENDER=ON

    # -DSDL_ASSEMBLY          # Enable assembly routines" ${SDL_ASSEMBLY_DEFAULT})
    # -DSDL_AVX               # Use AVX assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_AVX2              # Use AVX2 assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_AVX512F           # Use AVX512F assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_SSE               # Use SSE assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_SSE2              # Use SSE2 assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_SSE3              # Use SSE3 assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_SSE4_1            # Use SSE4.1 assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_SSE4_2            # Use SSE4.2 assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_MMX               # Use MMX assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_X86 OR SDL_CPU_X64" OFF
    # -DSDL_ALTIVEC           # Use Altivec assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_POWERPC32 OR SDL_CPU_POWERPC64" OFF
    # -DSDL_ARMNEON           # Use NEON assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_ARM32 OR SDL_CPU_ARM64" OFF
    # -DSDL_LSX               # Use LSX assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_LOONGARCH64" OFF
    # -DSDL_LASX              # Use LASX assembly routines" ON "SDL_ASSEMBLY;SDL_CPU_LOONGARCH64" OFF

    -DSDL_DLOPEN_NOTES=OFF    # Record dlopen dependencies in .note.dlopen section" TRUE UNIX_SYS OFF
    -DSDL_LIBC=ON             # Use the system C library" ${SDL_LIBC_DEFAULT})
    -DSDL_SYSTEM_ICONV=ON     # Use iconv() from system-installed libraries" ${SDL_SYSTEM_ICONV_DEFAULT}
    -DSDL_LIBICONV=OFF        # Prefer iconv() from libiconv, if available, over libc version" OFF
    -DSDL_GCC_ATOMICS=ON      # Use gcc builtin atomics" ${SDL_GCC_ATOMICS_DEFAULT})
    -DSDL_DBUS=ON             # Enable D-Bus support" ON "${UNIX_SYS}" OFF
    -DSDL_LIBURING=ON         # Enable liburing support" ON "${UNIX_SYS}" OFF
    -DSDL_DISKAUDIO=OFF       # Support the disk writer audio driver" ON "SDL_AUDIO" OFF
    -DSDL_DUMMYAUDIO=OFF      # Support the dummy audio driver" ON "SDL_AUDIO" OFF
    -DSDL_DUMMYCAMERA=OFF     # Support the dummy camera driver" ON SDL_CAMERA OFF
    -DSDL_DUMMYVIDEO=OFF      # Use dummy video driver" ON "SDL_VIDEO" OFF
    -DSDL_PTHREADS=ON         # Use POSIX threads for multi-threading" ${SDL_PTHREADS_DEFAULT})
    -DSDL_PTHREADS_SEM=ON     # Use pthread semaphores" ON "SDL_PTHREADS" OFF
    -DSDL_CLOCK_GETTIME=ON  # Use clock_gettime() instead of gettimeofday()" ${SDL_CLOCK_GETTIME_DEFAULT})
    -DSDL_BACKGROUNDING_SIGNAL=OFF # "number to use for magic backgrounding signal or 'OFF'" OFF
    -DSDL_FOREGROUNDING_SIGNAL=OFF # "number to use for magic foregrounding signal or 'OFF'" OFF

    # Audio
    -DSDL_OSS=OFF             # Support the OSS audio API" ${SDL_OSS_DEFAULT} "UNIX_SYS OR RISCOS;SDL_AUDIO" OFF
    -DSDL_ALSA=OFF            # Support the ALSA audio API" ${UNIX_SYS} "SDL_AUDIO" OFF
    -DSDL_JACK=OFF            # Support the JACK audio API" ${UNIX_SYS} "SDL_AUDIO" OFF
    -DSDL_PIPEWIRE=ON         # Use Pipewire audio" ${UNIX_SYS})
    -DSDL_PULSEAUDIO=OFF      # Use PulseAudio" ${UNIX_SYS} "SDL_AUDIO" OFF
    -DSDL_SNDIO=OFF           # Support the sndio audio API" ${UNIX_SYS} "SDL_AUDIO" OFF

    # Input
    -DSDL_HIDAPI=ON           # Enable the HIDAPI subsystem" ON "NOT VISIONOS" OFF
    -DSDL_HIDAPI_LIBUSB=ON    # Use libusb for low level joystick drivers" ON SDL_HIDAPI_LIBUSB_AVAILABLE OFF
    # -DSDL_HIDAPI_JOYSTICK   # Use HIDAPI for low level joystick drivers" ON SDL_HIDAPI OFF
    # -DSDL_VIRTUAL_JOYSTICK  # Enable the virtual-joystick driver" ON SDL_HIDAPI OFF
    -DSDL_LIBUDEV=ON          # Enable libudev support" ON
    # -DSDL_IBUS           # Enable IBus support" ON "${UNIX_SYS}" OFF

    # Video
    -DSDL_X11=OFF             # Use X11 video driver" ${UNIX_SYS} "SDL_VIDEO" OFF
    -DSDL_FRIBIDI=OFF         # "Enable Fribidi support" ON SDL_X11 OFF
    -DSDL_LIBTHAI=OFF         # "Enable Thai support" ON SDL_X11 OFF
    -DSDL_WAYLAND=ON          # Use Wayland video driver" ${UNIX_SYS} "SDL_VIDEO" OFF
    -DSDL_WAYLAND_LIBDECOR=OFF # Use client-side window decorations on Wayland" ON "SDL_WAYLAND" OFF
    -DSDL_RPI=OFF           # Use Raspberry Pi video driver" ON "SDL_VIDEO;UNIX_SYS;SDL_CPU_ARM32 OR SDL_CPU_ARM64" OFF
    -DSDL_ROCKCHIP=OFF      # Use ROCKCHIP Hardware Acceleration video driver" ON "SDL_VIDEO;UNIX_SYS;SDL_CPU_ARM32 OR SDL_CPU_ARM64" OFF
    -DSDL_COCOA=OFF         # Use Cocoa video driver" ON "APPLE" OFF
    -DSDL_DIRECTX=OFF       # Use DirectX for Windows audio/video" ON "SDL_AUDIO OR SDL_VIDEO;WINDOWS" OFF
    -DSDL_XINPUT=OFF        # Use Xinput for Windows" ON "WINDOWS" OFF
    -DSDL_WASAPI=OFF        # Use the Windows WASAPI audio driver" ON "WINDOWS;SDL_AUDIO" OFF
    -DSDL_RENDER_METAL=OFF  # Enable the Metal render driver" ON "SDL_RENDER;APPLE" OFF
    -DSDL_RENDER_GPU=OFF    # Enable the SDL_GPU render driver" ON "SDL_RENDER;SDL_GPU" OFF
    -DSDL_VIVANTE=OFF       # Use Vivante EGL video driver" ON "${UNIX_SYS};SDL_CPU_ARM32" OFF
    -DSDL_VULKAN=ON         # Enable Vulkan support" ON "SDL_VIDEO;ANDROID OR APPLE OR LINUX OR FREEBSD OR OPENBSD OR WINDOWS" OFF
    -DSDL_RENDER_VULKAN=ON  # Enable the Vulkan render driver" ON "SDL_RENDER;SDL_VULKAN" OFF
    -DSDL_METAL=OFF         # Enable Metal support" ON "APPLE" OFF
    -DSDL_OPENVR=OFF        # Use OpenVR video driver" OFF
    -DSDL_KMSDRM=OFF        # Use KMS DRM video driver" ${UNIX_SYS} "SDL_VIDEO" OFF
    -DSDL_OFFSCREEN=OFF     # Use offscreen video driver" ON
    -DSDL_OPENGL=OFF        # Include OpenGL support" ON "SDL_VIDEO;NOT IOS;NOT VISIONOS;NOT TVOS;NOT WATCHOS" OFF
    -DSDL_OPENGLES=OFF      # Include OpenGL ES support" ON "SDL_VIDEO;NOT VISIONOS;NOT TVOS;NOT WATCHOS" OFF

    # Build options
    -DSDL_ASAN=OFF          # Use AddressSanitizer to detect memory errors" OFF
    -DSDL_CCACHE=OFF        # Use Ccache to speed up build" OFF
    -DSDL_CLANG_TIDY=OFF    # Run clang-tidy static analysis" OFF
    -DSDL_TEST_LIBRARY=OFF  # Build the SDL3_test library" ON
    -DSDL_TESTS=OFF         # Build the test directory" ${SDL3_MAINPROJECT} SDL_TEST_LIBRARY OFF
    -DSDL_INSTALL_TESTS=OFF # Install test-cases" OFF "SDL_INSTALL;NOT SDL_FRAMEWORK" OFF
    -DSDL_EXAMPLES=OFF      # Build the examples directory")
  )

  cmake -S "SDL3-$pkgver" "${_cmake_options[@]}"
  cmake --build build
}

package() {
  DESTDIR="${pkgdir}" cmake --install build
  install -Dm644 "SDL3-${pkgver}/LICENSE.txt" -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
